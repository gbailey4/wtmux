<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="xterm.css">
<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #1e1e1e;
  }
  #terminal-container {
    width: 100%;
    height: 100%;
  }
</style>
</head>
<body>
<div id="terminal-container"></div>
<script src="xterm.js"></script>
<script src="xterm-addon-fit.js"></script>
<script>
(function() {
  const term = new Terminal({
    fontFamily: 'Menlo, Monaco, "Courier New", monospace',
    fontSize: 13,
    scrollback: 10000,
    cursorBlink: true,
    theme: {
      background: '#1e1e1e',
      foreground: '#cccccc',
      cursor: '#ffffff',
      selectionBackground: '#264f78',
      black: '#000000',
      red: '#cd3131',
      green: '#0dbc79',
      yellow: '#e5e510',
      blue: '#2472c8',
      magenta: '#bc3fbc',
      cyan: '#11a8cd',
      white: '#e5e5e5',
      brightBlack: '#666666',
      brightRed: '#f14c4c',
      brightGreen: '#23d18b',
      brightYellow: '#f5f543',
      brightBlue: '#3b8eea',
      brightMagenta: '#d670d6',
      brightCyan: '#29b8db',
      brightWhite: '#e5e5e5'
    }
  });

  const fitAddon = new FitAddon.FitAddon();
  term.loadAddon(fitAddon);
  term.open(document.getElementById('terminal-container'));

  // Send user input to Swift
  term.onData(function(data) {
    const encoded = btoa(unescape(encodeURIComponent(data)));
    window.webkit.messageHandlers.terminalInput.postMessage(encoded);
  });

  // Send resize events to Swift
  term.onResize(function(size) {
    window.webkit.messageHandlers.terminalResize.postMessage(
      JSON.stringify({ cols: size.cols, rows: size.rows })
    );
  });

  // Auto-fit on container resize
  const observer = new ResizeObserver(function() {
    requestAnimationFrame(function() {
      fitAddon.fit();
    });
  });
  observer.observe(document.getElementById('terminal-container'));

  // Swift → JS: write PTY output to terminal (as raw bytes for proper UTF-8)
  window.terminalWrite = function(base64) {
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
    term.write(bytes);
  };

  // Swift → JS: force fit recalculation
  window.terminalFit = function() {
    fitAddon.fit();
  };

  // Initial fit and signal ready
  requestAnimationFrame(function() {
    fitAddon.fit();
    const dims = { cols: term.cols, rows: term.rows };
    window.webkit.messageHandlers.terminalReady.postMessage(JSON.stringify(dims));
  });
})();
</script>
</body>
</html>
